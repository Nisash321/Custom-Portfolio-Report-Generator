<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Data Reporting Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- jsPDF Libraries for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #cbd5e1;
            transition: background-color 0.2s;
        }
        .drop-zone.sortable-ghost {
            background-color: #e2e8f0;
        }
        .field-item {
            cursor: grab;
            transition: background-color 0.2s;
        }
        .field-item:active {
            cursor: grabbing;
        }
        .field-item:hover {
            background-color: #f1f5f9;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Interactive Data Reporting Tool</h1>
            <p class="mt-2 text-lg text-gray-600">Upload a CSV/XLSX file, drag and drop fields to build your report, and download the result.</p>
        </header>

        <!-- File Upload Section -->
        <div id="upload-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">1. Upload Your Report(s)</h2>
            <div class="flex items-center space-x-4">
                <input type="file" id="file-input" multiple class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100" accept=".csv, .xlsx">
                <div id="loader" class="loader hidden"></div>
            </div>
             <div id="file-status" class="text-green-600 mt-2 text-sm font-medium"></div>
            <div id="file-error" class="text-red-500 mt-2 text-sm"></div>
        </div>
        
        <div id="main-content" class="hidden">
            <!-- Non-Tabular Data Display -->
            <div id="header-info-container" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4">Report Details (Preview of First File)</h2>
                <div id="header-info" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm"></div>
            </div>

            <!-- Pivot Table Builder -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4">2. Build Your Report</h2>
                
                <!-- Report Type Selection -->
                <div class="mb-6">
                    <label class="block text-base font-medium text-gray-700 mb-2">Report Type</label>
                    <fieldset class="flex items-center space-x-6">
                        <div class="flex items-center">
                            <input id="manual-selection" name="report-type" type="radio" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="manual-selection" class="ml-2 block text-sm font-medium text-gray-900">Manual Selection</label>
                        </div>
                        <div class="flex items-center">
                            <input id="preset-maharaja" name="report-type" type="radio" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="preset-maharaja" class="ml-2 block text-sm font-medium text-gray-900">Maharaja Report (Preset)</label>
                        </div>
                    </fieldset>
                </div>

                <!-- Drag and Drop Section -->
                <div id="drag-drop-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                    <div>
                        <h3 class="font-medium mb-2">Available Fields</h3>
                        <div id="available-fields" class="drop-zone p-3 rounded-md bg-gray-50 space-y-2">
                            <!-- Field items will be populated here -->
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium mb-2">Columns (Drag to reorder)</h3>
                        <div id="column-fields" class="drop-zone p-3 rounded-md bg-gray-50 space-y-2">
                            <!-- Field items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Preview Section -->
            <div id="preview-area" class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">3. Data Preview & Download</h2>
                     <div class="flex space-x-2">
                        <button id="download-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors disabled:bg-gray-400">
                            Download PDF
                        </button>
                        <button id="download-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400">
                            Download XLSX
                        </button>
                    </div>
                </div>
                <div id="table-container" class="overflow-x-auto">
                    <table id="preview-table" class="min-w-full divide-y divide-gray-200">
                        <!-- Table content will be generated here -->
                    </table>
                    <p id="no-data-message" class="text-gray-500 py-4">Drag fields into the 'Columns' box to see a preview.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let processedFilesData = [];
        let allHeaders = [];

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const fileError = document.getElementById('file-error');
        const fileStatus = document.getElementById('file-status');
        const mainContent = document.getElementById('main-content');
        const headerInfoDiv = document.getElementById('header-info');
        const availableFieldsContainer = document.getElementById('available-fields');
        const columnFieldsContainer = document.getElementById('column-fields');
        const previewTable = document.getElementById('preview-table');
        const noDataMessage = document.getElementById('no-data-message');
        const downloadBtn = document.getElementById('download-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const manualSelectionRadio = document.getElementById('manual-selection');
        const presetMaharajaRadio = document.getElementById('preset-maharaja');
        const dragDropSection = document.getElementById('drag-drop-section');

        // --- PRESET DEFINITION ---
        const maharajaPreset = {
            'S.no': 'S.No',
            'Fund Name': 'Product Name',
            'Fund category': 'Fund category',
            'Investment type': 'Investment type',
            'Folio No': 'Fund Name',
            'Invested Value': 'Purchase Cost Value',
            'Current Value': 'Current Value',
            'Invested Date': 'Folio start/re-start date',
            'XIRR': 'CAGR%'
        };

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', handleFileSelect);
        downloadBtn.addEventListener('click', downloadCombinedXLSX);
        downloadPdfBtn.addEventListener('click', downloadCombinedPDF);
        manualSelectionRadio.addEventListener('change', handleReportTypeChange);
        presetMaharajaRadio.addEventListener('change', handleReportTypeChange);

        /**
         * Formats a number using the Indian numbering system (lakhs, crores).
         * @param {number | string} num - The number to format.
         * @returns {string} The formatted number string.
         */
        function formatIndianCurrency(num) {
            const value = parseFloat(String(num).replace(/,/g, ''));
            if (isNaN(value)) {
                return '';
            }
            return value.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        /**
         * Handles the file selection event for multiple files.
         */
        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            resetUI();
            loader.classList.remove('hidden');
            
            processedFilesData = [];
            const processingPromises = [];

            for (const file of files) {
                processingPromises.push(processSingleFile(file));
            }

            try {
                processedFilesData = await Promise.all(processingPromises);
                
                if (processedFilesData.length > 0) {
                    fileStatus.textContent = `${processedFilesData.length} file(s) loaded successfully.`;
                    const firstFile = processedFilesData[0];
                    allHeaders = firstFile.allHeaders;
                    populateHeaderInfo(firstFile.headerInfoData);
                    
                    presetMaharajaRadio.checked = true;
                    handleReportTypeChange();
                    
                    mainContent.classList.remove('hidden');
                }
            } catch (error) {
                handleError(error.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        /**
         * Processes a single file and returns its parsed data.
         * @param {File} file - The file to process.
         * @returns {Promise<object>} A promise that resolves with the parsed data.
         */
        function processSingleFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        if (file.name.endsWith('.csv')) {
                            resolve(parseCSV(data));
                        } else if (file.name.endsWith('.xlsx')) {
                             const workbook = XLSX.read(data, { type: 'array' });
                             const firstSheetName = workbook.SheetNames[0];
                             const worksheet = workbook.Sheets[firstSheetName];
                             const csvString = XLSX.utils.sheet_to_csv(worksheet);
                             resolve(parseCSV(csvString));
                        } else {
                            throw new Error(`Unsupported file type: ${file.name}`);
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error(`Error reading file: ${file.name}`));
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        /**
         * Parses CSV data string and returns a structured object.
         * @param {string} csvString - The CSV data as a string.
         * @returns {object} The parsed data object.
         */
        function parseCSV(csvString) {
            const lines = csvString.replace(/\r\n/g, '\n').split('\n');
            
            let localHeaderInfo = {};
            const panRegex = /PAN:\s*([A-Z0-9]+)/;
            const emailRegex = /EMail:\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/;
            const mobileRegex = /Mobile No:\s*([+\d\s]+)/;

            lines.slice(0, 10).forEach(line => {
                if (line.includes('Investor:')) {
                    const fullBlock = line.split(',')[0].replace(/"/g, '');
                    const blockLines = fullBlock.split('\n');
                    blockLines.forEach(l => {
                        if (l.includes('Investor:')) localHeaderInfo['Investor Name'] = l.replace('Investor:', '').trim();
                        else if (l.includes('Address:')) localHeaderInfo['Address'] = l.replace('Address:', '').trim();
                    });
                }
                if (panRegex.test(line) && !localHeaderInfo['PAN']) localHeaderInfo['PAN'] = line.match(panRegex)[1];
                if (emailRegex.test(line) && !localHeaderInfo['Email']) localHeaderInfo['Email'] = line.match(emailRegex)[1];
                if (mobileRegex.test(line) && !localHeaderInfo['Mobile Number']) localHeaderInfo['Mobile Number'] = line.match(mobileRegex)[1];
            });

            let dataStartIndex = -1;
            const riskProfileAnchor = '(Risk profile:';
            let riskProfileIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes(riskProfileAnchor)) {
                    riskProfileIndex = i;
                    break;
                }
            }

            if (riskProfileIndex !== -1) {
                for (let i = riskProfileIndex + 1; i < lines.length; i++) {
                    if (lines[i].trim().length > 0) {
                        dataStartIndex = i;
                        break;
                    }
                }
            }

            if (dataStartIndex === -1) {
                throw new Error('Could not find the data table in the file. Ensure the format is correct and contains a "(Risk profile:" line.');
            }

            const cleanCsvBlock = lines.slice(dataStartIndex).join('\n');
            let localFullTableData = [];
            let currentCategory = 'N/A';
            const rawData = Papa.parse(cleanCsvBlock, { header: false, skipEmptyLines: true }).data;

            rawData.forEach(row => {
                const nonEmptyFields = row.filter(field => field && field.trim() !== '');
                if (nonEmptyFields.length === 1 && nonEmptyFields[0].includes('Fund')) {
                    currentCategory = nonEmptyFields[0].trim();
                } else if (row.length > 10 && !isNaN(parseFloat(row[0]))) {
                    let rowData = {};
                    let offset = (row[2] === '' || row[2] === null) ? 1 : 0;
                    rowData['S.No'] = row[0];
                    rowData['Fund Name'] = row[1];
                    rowData['Fund category'] = currentCategory;
                    rowData['Folio start/re-start date'] = row[2 + offset];
                    rowData['Product Name'] = row[3 + offset];
                    rowData['Balance Units'] = row[4 + offset];
                    rowData['Avg. Cost Price'] = row[5 + offset];
                    rowData['Purchase Cost Value'] = row[6 + offset];
                    rowData['Div. / Int. Paid'] = row[7 + offset];
                    rowData['Div. / Int. Reinv'] = row[8 + offset];
                    rowData['Avg. No. of Days'] = row[9 + offset];
                    rowData['Current NAV'] = row[10 + offset];
                    rowData['Current Value'] = row[11 + offset];
                    rowData['P+L'] = row[12 + offset];
                    rowData['Abs%'] = row[13 + offset];
                    rowData['CAGR%'] = row[14 + offset];
                    const folioString = String(row[1]).toLowerCase();
                    if (folioString.includes('sip')) rowData['Investment type'] = 'SIP';
                    else if (folioString.includes('stp')) rowData['Investment type'] = 'STP';
                    else rowData['Investment type'] = 'Lumpsum';
                    localFullTableData.push(rowData);
                }
            });
            
            const localAllHeaders = [
                'S.No', 'Fund Name', 'Fund category', 'Folio start/re-start date', 
                'Product Name', 'Balance Units', 'Avg. Cost Price', 'Purchase Cost Value', 
                'Div. / Int. Paid', 'Div. / Int. Reinv', 'Avg. No. of Days', 
                'Current NAV', 'Current Value', 'P+L', 'Abs%', 'CAGR%', 'Investment type'
            ];
            
            return { headerInfoData: localHeaderInfo, fullTableData: localFullTableData, allHeaders: localAllHeaders };
        }

        function handleReportTypeChange() {
            if (presetMaharajaRadio.checked) {
                dragDropSection.classList.add('hidden');
                applyMaharajaPreset();
            } else {
                dragDropSection.classList.remove('hidden');
                initializeDragDrop();
            }
            updatePreviewTable();
        }

        function applyMaharajaPreset() {
            availableFieldsContainer.innerHTML = '';
            columnFieldsContainer.innerHTML = '';

            for (const displayName in maharajaPreset) {
                const systemName = maharajaPreset[displayName];
                const fieldItem = createFieldItem(displayName, systemName);
                columnFieldsContainer.appendChild(fieldItem);
            }
            
            const presetSystemNames = Object.values(maharajaPreset);
            allHeaders.forEach(header => {
                if (!presetSystemNames.includes(header)) {
                    const fieldItem = createFieldItem(header, header);
                    availableFieldsContainer.appendChild(fieldItem);
                }
            });
        }

        function populateHeaderInfo(data) {
            headerInfoDiv.innerHTML = '';
            for (const key in data) {
                const infoItem = document.createElement('div');
                infoItem.innerHTML = `<span class="font-semibold text-gray-600">${key}:</span> <span class="text-gray-800">${data[key]}</span>`;
                headerInfoDiv.appendChild(infoItem);
            }
        }

        function initializeDragDrop() {
            availableFieldsContainer.innerHTML = '';
            columnFieldsContainer.innerHTML = '';
            allHeaders.forEach(header => {
                availableFieldsContainer.appendChild(createFieldItem(header, header));
            });

            new Sortable(availableFieldsContainer, { group: 'shared', animation: 150, ghostClass: 'sortable-ghost', onEnd: updatePreviewTable });
            new Sortable(columnFieldsContainer, { group: 'shared', animation: 150, ghostClass: 'sortable-ghost', onEnd: updatePreviewTable });
        }

        function createFieldItem(displayName, systemName) {
            const item = document.createElement('div');
            item.className = 'field-item bg-white p-2 rounded shadow-sm border border-gray-200';
            item.textContent = displayName;
            item.dataset.systemName = systemName;
            item.dataset.displayName = displayName;
            return item;
        }

        function updatePreviewTable() {
            const selectedColumns = Array.from(columnFieldsContainer.children);

            if (selectedColumns.length === 0 || processedFilesData.length === 0) {
                previewTable.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                downloadBtn.disabled = true;
                downloadPdfBtn.disabled = true;
                return;
            }

            noDataMessage.classList.add('hidden');
            downloadBtn.disabled = false;
            downloadPdfBtn.disabled = false;

            const previewData = processedFilesData[0].fullTableData.slice(0, 5);
            const thead = `<thead class="bg-gray-50"><tr>${selectedColumns.map(item => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${item.dataset.displayName}</th>`).join('')}</tr></thead>`;
            
            const tbody = `<tbody class="bg-white divide-y divide-gray-200">${previewData.map(row => {
                const cells = selectedColumns.map(item => {
                    const headerName = item.dataset.displayName;
                    let value = row[item.dataset.systemName] || '';
                    if (headerName === 'Invested Value' || headerName === 'Current Value') {
                        value = formatIndianCurrency(value);
                    }
                    return `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${value}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('')}</tbody>`;

            previewTable.innerHTML = thead + tbody;
        }
        
        function getFilename() {
            if (processedFilesData.length === 0) return 'Report.xlsx';
            const firstHeaderInfo = processedFilesData[0].headerInfoData;
            let investorName = (firstHeaderInfo['Investor Name'] || 'Report').replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
            investorName = investorName.charAt(0).toUpperCase() + investorName.slice(1);
            const date = new Date();
            const dateString = `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`;
            return `${investorName}_Family_${dateString}`;
        }

        function downloadCombinedPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            processedFilesData.forEach((fileData, index) => {
                if (index > 0) {
                    doc.addPage();
                }
                generatePDFPage(doc, fileData);
            });

            doc.save(`${getFilename()}.pdf`);
        }

        function generatePDFPage(doc, fileData) {
            const { headerInfoData, fullTableData } = fileData;
            const selectedColumns = Array.from(columnFieldsContainer.children);
            if (selectedColumns.length === 0) return;

            const date = new Date();
            const dateString = `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`;
            const investorName = headerInfoData['Investor Name'] || '';
            const reportDateString = `Mutual Fund Report as on : ${dateString}`;
            
            const startX = 15;
            const startY = 15;
            const lineHeight = 5;
            const padding = 2;

            // Calculate width of the text block for highlighting
            const investorNameWidth = doc.getStringUnitWidth(investorName) * 12 / doc.internal.scaleFactor;
            const dateStringWidth = doc.getStringUnitWidth(reportDateString) * 10 / doc.internal.scaleFactor;
            const highlightWidth = Math.max(investorNameWidth, dateStringWidth) + (padding * 2);
            const highlightHeight = (lineHeight * 2) + (padding * 2);

            // Draw highlight rectangle
            doc.setFillColor(230, 247, 255); // A light blue highlight color
            doc.rect(startX - padding, startY - lineHeight, highlightWidth, highlightHeight, 'F');

            // Set font for Investor Name (Bold)
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(investorName, startX, startY);

            // Set font for Date (Normal)
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(reportDateString, startX, startY + lineHeight);


            const headers = selectedColumns.map(item => item.dataset.displayName);
            const body = fullTableData.map(row => {
                return selectedColumns.map(item => {
                    const headerName = item.dataset.displayName;
                    let value = row[item.dataset.systemName] || '';
                    if (headerName === 'Invested Value' || headerName === 'Current Value') {
                        return formatIndianCurrency(value);
                    }
                    return value;
                });
            });

            let totalInvested = 0;
            let totalCurrent = 0;
            fullTableData.forEach(row => {
                totalInvested += parseFloat(String(row['Purchase Cost Value']).replace(/,/g, '')) || 0;
                totalCurrent += parseFloat(String(row['Current Value']).replace(/,/g, '')) || 0;
            });

            const totalRow = new Array(headers.length).fill('');
            const investedValueIndex = headers.indexOf('Invested Value');
            const currentValueIndex = headers.indexOf('Current Value');
            if (investedValueIndex > 0) totalRow[investedValueIndex - 1] = 'Total';
            if (investedValueIndex !== -1) totalRow[investedValueIndex] = formatIndianCurrency(totalInvested);
            if (currentValueIndex !== -1) totalRow[currentValueIndex] = formatIndianCurrency(totalCurrent);
            
            doc.autoTable({
                startY: startY + lineHeight + (padding * 2),
                head: [headers],
                body: body,
                foot: [totalRow],
                theme: 'grid',
                headStyles: { fillColor: [112, 173, 71], textColor: [255, 255, 255], fontStyle: 'bold' },
                footStyles: { fontStyle: 'bold' }
            });
        }

        function downloadCombinedXLSX() {
            const wb = XLSX.utils.book_new();
            processedFilesData.forEach(fileData => {
                const ws = generateXLSXSheet(fileData);
                const sheetName = (fileData.headerInfoData['Investor Name'] || 'Report').substring(0, 31);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            XLSX.writeFile(wb, `${getFilename()}.xlsx`);
        }

        function generateXLSXSheet(fileData) {
            const { headerInfoData, fullTableData } = fileData;
            const selectedColumns = Array.from(columnFieldsContainer.children);
            if (selectedColumns.length === 0) return;

            const parseCurrency = (val) => {
                if (typeof val !== 'string' && typeof val !== 'number') return 0;
                return parseFloat(String(val).replace(/,/g, '')) || 0;
            };

            let totalInvested = 0;
            let totalCurrent = 0;
            fullTableData.forEach(row => {
                totalInvested += parseCurrency(row['Purchase Cost Value']);
                totalCurrent += parseCurrency(row['Current Value']);
            });

            const date = new Date();
            const dateString = `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`;
            const investorDetails = [
                [`${headerInfoData['Investor Name'] || ''}`],
                [`Mutual Fund Report as on : ${dateString}`]
            ];

            const headers = selectedColumns.map(item => item.dataset.displayName);
            const dataToExport = fullTableData.map(row => {
                const newRow = [];
                selectedColumns.forEach(item => {
                    const headerName = item.dataset.displayName;
                    let value = row[item.dataset.systemName] || '';
                    if (headerName === 'Invested Value' || headerName === 'Current Value') {
                        value = formatIndianCurrency(value);
                    }
                    newRow.push(value);
                });
                return newRow;
            });

            const totalRow = new Array(headers.length).fill('');
            const investedValueIndex = headers.indexOf('Invested Value');
            const currentValueIndex = headers.indexOf('Current Value');
            if (investedValueIndex > 0) totalRow[investedValueIndex - 1] = 'Total';
            if (investedValueIndex !== -1) totalRow[investedValueIndex] = formatIndianCurrency(totalInvested);
            if (currentValueIndex !== -1) totalRow[currentValueIndex] = formatIndianCurrency(totalCurrent);

            const finalSheetData = [
                ...investorDetails, [], headers, ...dataToExport, [], totalRow
            ];

            const ws = XLSX.utils.aoa_to_sheet(finalSheetData);

            const boldFont = { bold: true };
            const headerStyle = { font: boldFont };
            const totalLabelStyle = { font: boldFont };
            // Use text format for currency to preserve Indian style
            const currencyStyle = { numFmt: "@" }; 
            const totalValueStyle = { font: boldFont, numFmt: '@' };

            // Style investor info rows
            for (let R = 0; R < investorDetails.length; R++) {
                const cellRef = XLSX.utils.encode_cell({ r: R, c: 0 });
                if (ws[cellRef]) ws[cellRef].s = headerStyle;
                ws['!merges'] = ws['!merges'] || [];
                ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: headers.length - 1 } });
            }

            const headerRowIndex = investorDetails.length + 1;
            headers.forEach((_, C) => {
                const cellRef = XLSX.utils.encode_cell({ r: headerRowIndex, c: C });
                if (ws[cellRef]) ws[cellRef].s = headerStyle;
            });

            const dataStartRow = headerRowIndex + 1;
            for (let R = 0; R < dataToExport.length; R++) {
                const currentRow = dataStartRow + R;
                if (investedValueIndex !== -1) {
                    const cellRef = XLSX.utils.encode_cell({ r: currentRow, c: investedValueIndex });
                    if (ws[cellRef]) { ws[cellRef].t = 's'; ws[cellRef].s = currencyStyle; }
                }
                if (currentValueIndex !== -1) {
                    const cellRef = XLSX.utils.encode_cell({ r: currentRow, c: currentValueIndex });
                    if (ws[cellRef]) { ws[cellRef].t = 's'; ws[cellRef].s = currencyStyle; }
                }
            }

            const totalRowIndex = dataStartRow + dataToExport.length + 1;
            if (investedValueIndex > 0) {
                const cellRef = XLSX.utils.encode_cell({ r: totalRowIndex, c: investedValueIndex - 1 });
                if (ws[cellRef]) ws[cellRef].s = totalLabelStyle;
            }
            if (investedValueIndex !== -1) {
                const cellRef = XLSX.utils.encode_cell({ r: totalRowIndex, c: investedValueIndex });
                if (ws[cellRef]) { ws[cellRef].t = 's'; ws[cellRef].s = totalValueStyle; }
            }
            if (currentValueIndex !== -1) {
                const cellRef = XLSX.utils.encode_cell({ r: totalRowIndex, c: currentValueIndex });
                if (ws[cellRef]) { ws[cellRef].t = 's'; ws[cellRef].s = totalValueStyle; }
            }
            
            const colWidths = headers.map((h) => ({ wch: Math.max(25, h.length) }));
            ws['!cols'] = colWidths;

            return ws;
        }

        function resetUI() {
            mainContent.classList.add('hidden');
            headerInfoDiv.innerHTML = '';
            availableFieldsContainer.innerHTML = '';
            columnFieldsContainer.innerHTML = '';
            previewTable.innerHTML = '';
            noDataMessage.classList.remove('hidden');
            downloadBtn.disabled = true;
            downloadPdfBtn.disabled = true;
            fileError.textContent = '';
            fileStatus.textContent = '';
            presetMaharajaRadio.checked = true; // Keep preset as default
            dragDropSection.classList.add('hidden');
        }

        function handleError(message) {
            console.error(message);
            fileError.textContent = message;
            loader.classList.add('hidden');
        }

    </script>
</body>
</html>
